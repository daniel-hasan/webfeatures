{% extends "../bases/base_main_site.html" %}
{% load static %}
{% block title %}Feature Set Update Insert{% endblock %}
  
{% block content %}

<script src="{% static "js/featureSetConfigUpdate.js" %}"></script>

<script>
	function cancelEditFeature(){
		window.location.href = '{% url "feature_set_list" %}';
	}
</script>

<div id="tabs">
  <ul>
    <li><a class="styletabs" href="#tabs-1">Description</a></li>
    <li><a class="styletabs" id="FeaturesSets" href="#tabs-2">Features Set</a></li>
  </ul>
  <div id="tabs-1">
  	<div class = "col-md-6">	
  		{% if object.id %}
  				<form id="updateFeatureForm" action="{% url "feature_set_edit" object.nam_feature_set %}" method="post">{% csrf_token %}
  			{% else %}
  				<form onsubmit="return false" action="{% url "feature_set_insert" %}" method="post">{% csrf_token %}
  		{% endif %}
				{% for field in form %}
					{{ field.errors }}
					<div class="form-group">
						{% ifequal field.label "Nam feature set" %}
							<span>Name Feature Set:</span>
						{% endifequal %}	
						
						{% ifequal field.label "Dsc feature set" %}
							<span>Description Feature Set:</span>
						{% endifequal %}
						
						{% ifequal field.label "Language" %}
							<span>Language:</span>
						{% endifequal %}
						
						<div>
	                    	{{ field }}
	                   </div>
	                </div>
	    		{% endfor %}
	    		<button type="submit" id="saveButton" class="ui-button ui-widget ui-corner-all">Save</button>
	    		<input type="button" class="ui-button ui-widget ui-corner-all" onclick="cancelEditFeature()" value = "Cancel" />
		</form>
	</div>
  </div>
  
  <div id="alertSaveFeature">
  	<p>Do you want to save your changes?</p>
  </div>
  
  <!-- form create/update via ajax --> 
  <script>
  		
  		let href_button_clicked = "";
  		let boolChange=false;
  		
  		$("#updateFeatureForm :input").change(function() {
		   $("#updateFeatureForm").data("changed",true);
		});
		
  		$( "#configureFeatureSet" ).click(function() {
			href_button_clicked = "";
			$(this).removeAttr( "href" );
	  		if ($("#updateFeatureForm").data("changed")) {
	  			href_button_clicked = "{% url "feature_set_list"%}";
	 			$( "#alertSaveFeature" ).dialog( "open" );
	 		} else if($(".custom-combobox-input").change()){
	 			href_button_clicked = "{% url "feature_set_list"%}";
	 			$( "#alertSaveFeature" ).dialog( "open" );	 		
	 		} else {
	 			$( "#configureFeatureSet" ).attr("href","{% url "feature_set_list"%}");
	 		}
	 	});
	 	
	 	$( "#analyseTexts" ).click(function() {
	 		href_button_clicked = "";
	 		$(this).removeAttr( "href" );
	  		if ($("#updateFeatureForm").data("changed")) {
	 			href_button_clicked = "{% url "extract_features" %}";
	 			$( "#alertSaveFeature" ).dialog( "open" );
	 		} else if($(".custom-combobox-input").change()){
	 			href_button_clicked = "{% url "extract_features" %}";
	 			$( "#alertSaveFeature" ).dialog( "open" );	 		
	 		} else {
	 			$( "#analyseTexts" ).attr("href","{% url "extract_features" %}");
	 		}
  		});
		
		$( "#publications" ).click(function() {
			href_button_clicked = "";
			$(this).removeAttr( "href" );
	  		if ($("#updateFeatureForm").data("changed")) {
	  			href_button_clicked = "{% url "publications" %}";
	 			$( "#alertSaveFeature" ).dialog( "open" );
	 		} else if($(".custom-combobox-input").change()){
	 			href_button_clicked = "{% url "publications" %}";
	 			$( "#alertSaveFeature" ).dialog( "open" );	 		
	 		} else {
	 			$( "#publications" ).attr("href","{% url "publications"%}");
	 		}
  		});
  		
  		$( "#FeaturesSets" ).click(function() {
			if ($("#updateFeatureForm").data("changed")) {
				salveData();
	 		} else if($(".custom-combobox-input").change()){
	 			salveData();	 		
	 		}
  		});
  		
  		$( function() {
	         $("#alertSaveFeature").dialog({
			    autoOpen: false,
			    modal: true,
			    title: 'Configure Feature Set ',
			    width: 400, 
			    height: 'auto',
			    buttons: {
			        "Yes": function() {
			          salveData();
			          window.location.href = href_button_clicked;
			          $( this ).dialog( "close" );
			          },
			        
			        "No": function() {
			          window.location.href = href_button_clicked;
			          $( this ).dialog( "close" );
			          }
			      }	
			 });	
		});	
		
		function salveData(){
			let idNamFeaturesSet = "{{object.nam_feature_set}}";
		  	let arrElementsFeatureSet = [];
		  	let arrCreateElementsFeatureSet = [];
		  	
			arrElementsFeatureSet.push({"id_nam_feature_set":idNamFeaturesSet,"nam_feature_set": $('#id_nam_feature_set').val(),"dsc_feature_set":$('#id_dsc_feature_set').val(), "language":$('#id_language').val()});
			arrCreateElementsFeatureSet.push({"nam_feature_set": $('#id_nam_feature_set').val(),"dsc_feature_set":$('#id_dsc_feature_set').val(), "language":$('#id_language').val()});
		
			{% if object.id %}
				
				updateFeatureSet(arrElementsFeatureSet);
				
				{% else %}
	  		
	  			createFeatureSet(arrCreateElementsFeatureSet);
	  			
	  		{% endif %}	
		}
		  		
	  	$( "#saveButton" ).click(function() {
	  		salveData();
		});
	  
	  //window.location.hash
	  
		function createFeatureSet(arrCreateElementsFeatureSet){			
			$.ajax({
				  url: "{% url "feature_set_insertAJAX" %}",
				  dataType: 'json',
				  type: "POST",
			  	  data: { "arrCreateElementsFeatureSet" : JSON.stringify(arrCreateElementsFeatureSet)},
				  success: function(response) {
				  		alert("Deu certo");
				  		console.log("It is working");
				  		gUsedFeaturesNames = {};
				  		
				  		$( "#insert" ).on( "click", function() {						    
						     $( "#add-form" ).dialog( "open" );
						     let combo = $('#id_language')[0];
						     let textoCombo = combo.options[combo.selectedIndex].text;
						     let lingua = textoCombo.substring(1, 3);
						     let list = $("#featureList");
						     getFeatureList( list[0] ,lingua);
						
						});
				  	
				  },
				  error: function(xhr,status,error){
				  		alert("An error occured when trying to save the new configurations:\n"+error);
		       	  }
				});
		}
		
		function updateFeatureSet(arrElementsFeatureSet){			
			$.ajax({
				  url: "{% url "feature_set_editAJAX" %}",
				  dataType: 'json',
				  type: "POST",
			  	  data: { "arrEditElementsFeatureSet" : JSON.stringify(arrElementsFeatureSet)},
				  success: function(response) {
				  		console.log("It is working");
				  },
				  error: function(xhr,status,error){
				  		alert("An error occured when trying to save the new configurations:\n"+error);
		       	  }
				});
		}
		
  </script>
    
  <div id="tabs-2">
  	<a><button id="insert">Add Feature</button></a>
  	<br><br>
  	<ul id='div'></ul>
  	
  		<script>
  		//Insert gif loading
  			var imagem = document.createElement('img');
  			imagem.src = "{% static "imgs/ajax-loader.gif" %}";
  			imagem.id = "imgLoader";
  		
  		// Insert image confirm	
  			var imagemConfirm = document.createElement('img');
  			imagemConfirm.src = "{% static "imgs/ajax-confirm.png" %}";
  			imagemConfirm.id = "imgConfirm";
		
  		</script>
  			<script src="{% url "usedFeatures.js" object.nam_feature_set %}"></script>
  		</div>
</div>

<div id="add-form" title="Add Feature Set">
	<div id="featureList"></div>
	 <script src="{% url "insert_list_used_features" %}"></script>
	 <script src="{% static "js/csrf_token_ajax.js" %}"></script>
</div>

{% endblock %}
